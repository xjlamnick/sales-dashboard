name: Auto Update from Google Sheets - No Cache

on:
  schedule:
    - cron: '0 */3 * * *'   # кожні 3 години

  workflow_dispatch:        # ручний запуск

jobs:
  update-data:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      # 1. Повне оновлення репозиторію (без кешу попередніх файлів)
      - name: Checkout repository (clean)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          clean: true           # видаляє непотрібні файли
          persist-credentials: true

      # 2. Видаляємо старий sales-data.json примусово (на всяк випадок)
      - name: Remove old sales-data.json
        run: rm -f sales-data.json || true

      # 3. Встановлюємо Python
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      # 4. Встановлюємо залежності
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # 5. Завантажуємо дані з Google Sheets з повним відключенням кешу
      - name: Fetch fresh data from Google Sheets (no cache)
        env:
          # Додаємо випадковий параметр, щоб уникнути кешування на рівні CDN Google
          CACHE_BUSTER: ${{ github.run_id }}-${{ github.run_attempt }}
        run: |
          # Використовуємо curl з явним відключенням кешу + випадковий параметр
          curl -H "Cache-Control: no-cache, no-store, must-revalidate" \
               -H "Pragma: no-cache" \
               -H "Expires: 0" \
               -o temp.csv \
               "${{ secrets.GOOGLE_SHEET_CSV_URL }}?v=$CACHE_BUSTER"

          # Перевіряємо, чи завантажилось щось
          head -n 5 temp.csv

          # Переміщуємо в місце, де очікує скрипт (якщо потрібно)
          mv temp.csv sales-data-temp.csv || true

      # 6. Запускаємо скрипт (можна версія з використанням тимчасового файлу)
      - name: Process Google Sheet data
        run: python fetch_google_sheet.py

      # 7. Додаємо дебаг-інформацію
      - name: Show what was downloaded
        run: |
          echo "Перші 10 рядків отриманого CSV:"
          head -n 10 sales-data-temp.csv || cat temp.csv || echo "Файл не знайдено"
          echo ""
          echo "Розмір sales-data.json після обробки:"
          ls -lh sales-data.json || echo "sales-data.json не створено"

      # 8. Коміт і пуш тільки якщо є зміни
      - name: Commit and push if changed
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

          git add sales-data.json

          # Перевіряємо, чи є реальні зміни
          git diff --staged --quiet && echo "Немає змін для коміту" && exit 0

          git commit -m "chore: auto update sales data from Google Sheets $(date '+%Y-%m-%d %H:%M UTC')"

          echo "Спробуємо запушити..."

          for i in {1..5}; do
            echo "Спроба $i / 5"
            if git push origin HEAD:${{ github.ref_name }}; then
              echo "Успішно запушено"
              exit 0
            fi
            echo "Конфлікт → робимо pull --rebase"
            git pull --rebase origin ${{ github.ref_name }} || true
            sleep 3
          done

          echo "Не вдалося запушити після 5 спроб"
          exit 1
